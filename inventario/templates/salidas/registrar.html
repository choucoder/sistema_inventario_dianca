{% extends 'base.html' %}

{% block title %}Registrar Salida{% endblock %}

{% block page_title %}Registrar Salida de Producto{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<style>
    .ui-autocomplete {
        max-height: 350px;
        overflow-y: auto;
        overflow-x: hidden;
        z-index: 1050 !important;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .ui-menu-item {
        font-size: 14px;
        padding: 2px 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .ui-menu-item:last-child {
        border-bottom: none;
    }
    .ui-menu-item-wrapper {
        padding: 8px 12px;
    }
    .ui-state-active,
    .ui-menu-item-wrapper:hover {
        background-color: #007bff !important;
        border-color: #007bff !important;
        color: white !important;
        margin: 0;
    }
    .ui-state-active strong,
    .ui-menu-item-wrapper:hover strong {
        color: white !important;
    }
    .ui-state-active small,
    .ui-menu-item-wrapper:hover small {
        color: rgba(255,255,255,0.9) !important;
    }
    .search-input-wrapper {
        position: relative;
    }
    .search-input-wrapper .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
        pointer-events: none;
        z-index: 5;
    }
    .search-input-wrapper input {
        padding-left: 38px !important;
    }
</style>
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'salida_historial' %}">Salidas</a></li>
<li class="breadcrumb-item active">Registrar</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card card-danger">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    Nueva Salida
                </h3>
            </div>
            <form method="post" id="formSalida">
                {% csrf_token %}
                <div class="card-body">
                    <!-- Busqueda de producto -->
                    <div class="form-group">
                        <label for="product_code">
                            Codigo del Producto <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <div class="search-input-wrapper flex-fill">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text"
                                       class="form-control"
                                       id="product_code"
                                       name="product_code"
                                       value="{{ product_code }}"
                                       placeholder="Busque por nombre o codigo del producto..."
                                       maxlength="50"
                                       required
                                       autocomplete="off"
                                       autofocus>
                            </div>
                            <div class="input-group-append">
                                <button type="button" class="btn btn-info" id="btnBuscar">
                                    <i class="fas fa-check"></i> Verificar
                                </button>
                            </div>
                        </div>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> Escriba el nombre o codigo del producto para buscar.
                        </small>
                    </div>

                    <!-- Info del producto -->
                    <div id="productInfo" class="card card-outline card-info mb-3" style="display: none;">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-box mr-2"></i>
                                <span id="productName">-</span>
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>Categoria:</strong> <span id="productCategory">-</span></p>
                                    <p class="mb-1"><strong>Unidad:</strong> <span id="productUnit">-</span></p>
                                    <p class="mb-0"><strong>Ubicacion:</strong> <span id="productLocation">-</span></p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1">
                                        <strong>Stock Disponible:</strong>
                                        <span id="productStock" class="badge">-</span>
                                    </p>
                                    <p class="mb-1"><strong>Stock Minimo:</strong> <span id="productMinStock">-</span></p>
                                    <p class="mb-0" id="stockAlert"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Error -->
                    <div id="productError" class="alert alert-danger" style="display: none;">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <span id="productErrorMsg"></span>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="receptor">
                                    Receptor <span class="text-danger">*</span>
                                </label>
                                <input type="text"
                                       class="form-control"
                                       id="receptor"
                                       name="receptor"
                                       value="{{ receptor }}"
                                       placeholder="Persona o area que recibe"
                                       maxlength="200"
                                       required>
                                <small class="form-text text-muted">Quien recibe el producto</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="quantity">
                                    Cantidad <span class="text-danger">*</span>
                                </label>
                                <input type="number"
                                       class="form-control"
                                       id="quantity"
                                       name="quantity"
                                       value="{{ quantity }}"
                                       min="1"
                                       placeholder="0"
                                       required>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="motivo">
                            Motivo <span class="text-danger">*</span>
                        </label>
                        <textarea class="form-control"
                                  id="motivo"
                                  name="motivo"
                                  rows="3"
                                  placeholder="Indique el motivo de la salida..."
                                  required>{{ motivo }}</textarea>
                    </div>
                </div>

                <div class="card-footer">
                    <button type="submit" class="btn btn-danger" id="btnSubmit">
                        <i class="fas fa-save mr-1"></i> Registrar Salida
                    </button>
                    <a href="{% url 'salida_historial' %}" class="btn btn-secondary">
                        <i class="fas fa-times mr-1"></i> Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card card-info">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-info-circle mr-2"></i>
                    Instrucciones
                </h3>
            </div>
            <div class="card-body">
                <ol class="mb-0">
                    <li class="mb-2">Escanee o ingrese el codigo del producto</li>
                    <li class="mb-2">Verifique el stock disponible</li>
                    <li class="mb-2">Ingrese quien recibe el producto</li>
                    <li class="mb-2">Indique la cantidad a retirar</li>
                    <li class="mb-2">Describa el motivo de la salida</li>
                    <li>Haga clic en "Registrar Salida"</li>
                </ol>
            </div>
        </div>

        <div class="card card-warning">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    Importante
                </h3>
            </div>
            <div class="card-body">
                <p class="mb-0">
                    Al registrar la salida, el stock del producto se reducira automaticamente.
                    Verifique la cantidad y disponibilidad antes de confirmar.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script>
$(document).ready(function() {
    const btnBuscar = $('#btnBuscar');
    const inputCode = $('#product_code');
    const productInfo = $('#productInfo');
    const productError = $('#productError');

    // Configurar autocomplete
    inputCode.autocomplete({
        source: function(request, response) {
            $.ajax({
                url: '{% url "buscar_productos_autocomplete" %}',
                data: { term: request.term },
                success: function(data) {
                    response(data);
                },
                error: function() {
                    response([]);
                }
            });
        },
        minLength: 2,
        select: function(event, ui) {
            inputCode.val(ui.item.code);
            setTimeout(function() {
                buscarProducto();
            }, 100);
            return false;
        },
        focus: function(event, ui) {
            inputCode.val(ui.item.code);
            return false;
        }
    }).autocomplete("instance")._renderItem = function(ul, item) {
        return $("<li>")
            .append("<div style='padding: 5px 0;'>" +
                    "<div><strong style='color: #007bff;'><i class='fas fa-barcode'></i> " + item.code + "</strong> - " + item.name + "</div>" +
                    "<small class='text-muted'><i class='fas fa-tag'></i> " + item.category + " | <i class='fas fa-boxes'></i> Stock: " + item.stock_actual + "</small>" +
                    "</div>")
            .appendTo(ul);
    };

    function buscarProducto() {
        const code = inputCode.val().trim();
        if (!code) {
            productInfo.hide();
            productError.hide();
            return;
        }

        btnBuscar.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');

        $.ajax({
            url: '{% url "buscar_producto" %}',
            data: { code: code },
            success: function(data) {
                if (data.found) {
                    productError.hide();
                    $('#productName').text(data.product.name);
                    $('#productCategory').text(data.product.category);
                    $('#productUnit').text(data.product.unit);
                    $('#productLocation').text(data.product.location);
                    $('#productMinStock').text(data.product.min_stock);

                    const stockBadge = $('#productStock');
                    stockBadge.text(data.product.stock_actual);
                    stockBadge.removeClass('badge-success badge-danger badge-warning');

                    const alertDiv = $('#stockAlert');
                    if (data.product.stock_actual <= 0) {
                        stockBadge.addClass('badge-danger');
                        alertDiv.html('<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> SIN STOCK DISPONIBLE</span>');
                    } else if (data.product.stock_actual <= data.product.min_stock) {
                        stockBadge.addClass('badge-warning');
                        alertDiv.html('<span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Stock bajo</span>');
                    } else {
                        stockBadge.addClass('badge-success');
                        alertDiv.html('<span class="text-success"><i class="fas fa-check-circle"></i> Stock disponible</span>');
                    }

                    productInfo.show();
                } else {
                    productInfo.hide();
                    $('#productErrorMsg').text(data.error);
                    productError.show();
                }
            },
            error: function() {
                productInfo.hide();
                $('#productErrorMsg').text('Error al buscar el producto');
                productError.show();
            },
            complete: function() {
                btnBuscar.prop('disabled', false).html('<i class="fas fa-check"></i> Verificar');
            }
        });
    }

    inputCode.on('keypress', function(e) {
        if (e.which === 13) {
            e.preventDefault();
            buscarProducto();
        }
    });

    btnBuscar.on('click', buscarProducto);

    if (inputCode.val().trim()) {
        buscarProducto();
    }
});
</script>
{% endblock %}
